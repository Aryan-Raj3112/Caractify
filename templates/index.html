{% extends "layout.html" %}

{% block content %}
<body>
    <div class="sidebar">
        <div class="button-group">
            <button class="icon-button" onclick="location.href='/'">
                <span class="tooltip">Home</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </button>
            <button class="icon-button" onclick="restartChat()">
                <span class="tooltip">New Chat</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M2 12h20"/>
                </svg>
            </button>
        </div>
    </div>
    <div class="main-content">
        <header class="header">
            <img src="{{ url_for('static', filename=config.image) }}" alt="Logo">
            <h2>{{ config.title }}</h2>
        </header>

        <div class="chat-box">
            {% if chat_history %}
                {% for message in chat_history %}
                    <div class="message {{ message['role'] }}-msg">
                        {% if message['role'] == 'model' %}
                            {{ message['parts'] | markdown | safe }}
                        {% else %}
                            {{ message['parts'] | safe }}
                        {% endif %}
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Loading Spinner -->
        <div id="loading" style="display: none;">
            <div class="loading-spinner"></div>
        </div>

        <footer class="footer">
            <form action="/stream" method="GET" id="chatForm">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <textarea autocomplete="off" autofocus name="message" 
                        placeholder="Enter your message" required id="messageInput"></textarea>
            </form>
            <div class="disclaimer">AI-generated, for reference only</div>
        </footer>
    </div>
    <!-- Add Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- Keep the header, chat-box, and footer HTML unchanged -->
    <script>
        // Configure Markdown first
        marked.setOptions({
            breaks: true,
            mangle: false,
            headerIds: false
        });

        // Helper Functions
        function appendMessage(text, role) {
            const chatBox = document.querySelector('.chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}-msg`;
            const sanitized = DOMPurify.sanitize(text);
            msgDiv.innerHTML = role === 'model' ? marked.parse(sanitized) : sanitized;
            chatBox.appendChild(msgDiv);
            scrollToBottom();
            return msgDiv;
        }

        const messageInput = document.getElementById('messageInput');

        // Textarea Auto-Grow
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const newHeight = Math.max(30, Math.min(this.scrollHeight, 160));
            this.style.height = newHeight + 'px';
        });

        // Enter Key Handler
        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                document.getElementById('chatForm').dispatchEvent(new Event('submit'));
            }
        });

        function scrollToBottom() {
            const chatBox = document.querySelector('.chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Form Handler
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rawMessage = formData.get('message') || '';
            const message = rawMessage.trim();
            const sessionId = formData.get('session_id') || '';
            
            // Client-side validation
            if (!message) {
                messageInput.focus();
                return;
            }
            if (!sessionId) {
                alert('Invalid session');
                return;
            }

            // Disable input during processing
            messageInput.disabled = true;
            document.getElementById('loading').style.display = 'block';

            // Clear input and add messages
            e.target.reset();
            appendMessage(message, 'user');
            const modelMessage = appendMessage('', 'model');

            const eventSource = new EventSource(`/stream?message=${encodeURIComponent(message)}&session_id=${encodeURIComponent(sessionId)}`);
            
            // Modify the eventSource.onmessage handler
            eventSource.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.chunk) {
                    modelMessage.innerHTML = marked.parse(data.chunk, {
                        gfm: true,
                        breaks: true,
                        smartLists: true,
                        pedantic: false,
                        sanitize: false
                    });
                    scrollToBottom();
                }
                document.getElementById('loading').style.display = 'none';
            };

            eventSource.onerror = (err) => {
                eventSource.close();
                document.getElementById('loading').style.display = 'none';
                messageInput.disabled = false;
                messageInput.focus();
            };
        });
        function restartChat() {
            const currentPath = window.location.pathname;
            const chatType = currentPath.split('/').pop();
            if (chatType) {
                window.location.href = '/chat/' + chatType;
            } else {
                window.location.href = '/';
            }
        }
    </script>
</body>
{% endblock %}