{% extends "layout.html" %}

{% block content %}
<body>
    <input type="hidden" id="isLoggedIn" value="{{ 'true' if current_user.is_authenticated else 'false' }}">
    <input type="hidden" id="chatType" value="{{ config.name }}">
    <div class="sidebar">
        <div class="button-group">
            <button class="icon-button" onclick="location.href='/'">
                <span class="tooltip">Home</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </button>
            <button class="icon-button" onclick="restartChat()">
                <span class="tooltip">New Chat</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M2 12h20"/>
                </svg>
            </button>
        </div>
        <div class="chat-history">
            <h3 class="history-title">Recent Chats</h3>
            {%- if sessions -%}
            <ul class="session-list">
            {%- for session in sessions -%}
            <li class="session-item" data-session-id="{{ session.session_id }}">
                <a href="{{ url_for('load_chat', session_id=session.session_id) }}">
                    <span class="chat-type">{{ session.title }}</span>
                </a>
                <div class="chat-menu">
                    <button class="menu-button" onclick="toggleMenu(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="7" r="1"></circle>
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="17" r="1"></circle>
                        </svg>
                    </button>
                    <div class="menu-options">
                        <div class="menu-option" onclick="startRenaming('{{ session.session_id }}', '{{ session.title }}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                            </svg>
                            Rename
                        </div>
                        <div class="menu-option" onclick="confirmDelete('{{ session.session_id }}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </div>
                    </div>
                </div>
            </li>
            {%- endfor %}
            </ul>
            {%- else -%}
            <p class="no-chats">No previous chats</p>
            {%- endif -%}
            {% if not current_user.is_authenticated %}
                <div class="sidebar-disclaimer">
                    Heads up! Your chat history isn't being saved. <a href="{{ url_for('login') }}">Login</a> to save chats.
                </div>
            {% endif %}
        </div>
    </div>
    <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    <div class="main-content">
        <header class="header">
            <h2>{{ config.title }}</h2>
            <p class="description">{{ config.description }}</p>
        </header>

        <div class="chat-box">
        {%- if chat_history -%}
            {%- for message in chat_history -%}
                <div class="message {{ message['role'] }}-msg"><div class="message-content">
                    {%- for part in message.parts -%}
                        {%- if part.type == "image_ref" -%}
                        <img src="{{ url_for('get_image', image_id=part.image_id) }}" class="chat-image" alt="Uploaded image">
                        {%- else -%}
                        {%- if part.content -%}
                        {{- part.content | markdown | safe if message.role == 'model' else part.content | safe -}}
                        {%- endif -%}
                        {%- endif -%}
                    {%- endfor -%}</div></div>
            {%- endfor -%}
        {%- endif %}
        </div>

        <div id="loading" style="display: none;">
            <div class="bouncing-dots">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="loading-text">Thinking</div>
        </div>

        <footer class="footer">
            <form action="/stream" method="POST" enctype="multipart/form-data" id="chatForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="chat_type" value="{{ config.name }}">
                <div class="textarea-container">
                    <input type="file" id="imageInput" name="image" accept="image/*" hidden>
                    <button type="button" class="image-upload-button" onclick="document.getElementById('imageInput').click()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="20" height="20">
                            <g data-name="29-Images">
                                <path fill="#2ecc71" d="M29 6v22a1 1 0 0 1-1 1H6a2 2 0 0 0 2 2h20a3 3 0 0 0 3-3V8a2 2 0 0 0-2-2z"/>
                                <path fill="#2ecc71" d="M27 24V4a3 3 0 0 0-3-3H4a3 3 0 0 0-3 3v20a3 3 0 0 0 3 3h20a3 3 0 0 0 3-3zm-7.71-10.71L15 17.59l-4.29-4.29a1 1 0 0 0-1.41 0L3 19.59V4a1 1 0 0 1 1-1h20a1 1 0 0 1 1 1v13.59l-4.29-4.29a1 1 0 0 0-1.42-.01z"/>
                                <path fill="#2ecc71" d="M15 6a3 3 0 1 0 3 3 3 3 0 0 0-3-3zm0 4a1 1 0 1 1 1-1 1 1 0 0 1-1 1z"/>
                            </g>
                        </svg>
                    </button>
                    <div class="image-preview-container" id="imagePreview"></div>
                    <textarea autocomplete="off" name="message" placeholder="Enter your message" required id="messageInput"></textarea>
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="25" height="25" viewBox="0 0 2048 2048" style="shape-rendering:geometricPrecision;text-rendering:geometricPrecision;image-rendering:optimizeQuality;fill-rule:evenodd;clip-rule:evenodd">
                            <defs><style>.fil0{fill:none}.fil1{fill:#249962}</style></defs>
                            <g id="Layer_x0020_1">
                            <path class="fil0" d="M0 0h2048v2048H0z"/>
                            <path class="fil0" d="M255.999 255.999h1536v1536h-1536z"/>
                            <path class="fil0" d="M255.999 255.998h1536v1536h-1536z"/>
                            <g id="_340355200">
                            <path id="_340355512" class="fil1" d="m1024 1487.32 691.45-1151.869L627.874 1412.43l79.496 180.43z"/>
                            <path id="_340355368" class="fil1" d="m545.954 1372.19 7.14 15.332L716.81 1734.63c12.145 25.922 35.448 45.978 62.293 53.951 26.572 7.74 53.418 2.187 70.837-14.946 70.609-68.834 178.526-176.642 174.054-180.77l-478.042-220.675z"/>
                            <path id="_340355272" d="M316.565 1075.21c-32.628 18.92-52.417 54.115-51.276 91.865.922 37.762 22.406 72.086 56.104 89.062l368.093 187.708 1025.96-1108.4-874.489 1185.85 503.397 256.514c31.854 16.302 69.863 16.928 102.464 1.044 32.358-15.822 55.331-45.92 62.443-81.164l272.791-1397.76c2.84-14.213-3.01-28.794-14.803-37.086-7.738-5.503-17-7.714-25.994-6.548l-1.94.308c-4.055.762-8.034 2.236-11.793 4.397l-1410.96 814.208z" style="fill:#2ecc71"/>
                            </g>
                            </g>
                        </svg>
                    </button>
                </div>
            </form>
            <div class="disclaimer">AI-generated, for reference only</div>
        </footer>
    </div>
    <div class="confirmation-modal" id="deleteModal">
        <div class="modal-content">
            <p>Are you sure you want to delete this chat?</p>
            <div class="modal-buttons">
                <button class="modal-button confirm" onclick="handleDeleteConfirmation(true)">Yes</button>
                <button class="modal-button cancel" onclick="handleDeleteConfirmation(false)">No</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/base16/material-darker.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/bash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/yaml.min.js"></script>
    <script>hljs.configure({languages: ['python', 'javascript', 'json', 'bash', 'yaml', 'html', 'css', 'java', 'c', 'cpp', 'ruby']});</script>
    <script>hljs.highlightAll();</script>
    
    <script>
        marked.setOptions({
            breaks: true,
            mangle: false,
            headerIds: false,
            gfm: true,
            sanitize: false,
            smartypants: true,
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            }
        });

        let userInterruptedScroll = false;
        let scrollTimeout = null;

        let retries = 0;
        const MAX_RETRIES = 5;

        async function checkHealth() {
            let retries = 0;
            const MAX_RETRIES = 8;
            const RETRY_DELAY = 2000;

            async function attemptHealthCheck() {
                try {
                    const response = await fetch('/health');
                    if (response.status === 200) {
                        if (retries > 0) {
                            window.location.reload(true);
                        }
                        return true;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    retries++;
                    if (retries <= MAX_RETRIES) {
                        showLoadingScreen(retries, MAX_RETRIES);
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * Math.pow(2, retries-1)));
                        return attemptHealthCheck();
                    }
                    showErrorScreen();
                    return false;
                }
            }

            return attemptHealthCheck();
        }

        function showLoadingScreen() {
            if(!document.getElementById('loading-screen')) {
                const div = document.createElement('div');
                div.id = 'loading-screen';
                div.innerHTML = `
                    <div class="loading-message">
                        <div class="spinner"></div>
                        <p>Application is waking up...</p>
                        <p>Retry ${retries}/${MAX_RETRIES}</p>
                    </div>
                `;
                document.body.prepend(div);
            }
        }

        // Initial check
        window.addEventListener('load', () => {
            if(window.performance.navigation.type === 1) { // Only on reloads
                checkHealth();
            }
        });

        // Helper Functions
        function appendMessage(parts, role) {
            const chatBox = document.querySelector('.chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}-msg`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Ensure parts is always an array
            parts = Array.isArray(parts) ? parts : [parts || { type: 'text', content: '' }];
            
            parts.forEach(part => {
                if (part.type === 'text') {
                    messageContent.innerHTML += role === 'model' 
                        ? marked.parse(part.content.replace(/\n{2,}/g, '\n'))
                        : DOMPurify.sanitize(part.content);
                } else if (part.type === 'image_ref') {
                    const img = document.createElement('img');
                    img.src = `/image/${part.image_id}`;
                    img.className = 'chat-image';
                    messageContent.prepend(img);
                }
            });
            msgDiv.appendChild(messageContent);
            chatBox.appendChild(msgDiv);
    
            // Process code blocks after message is added to DOM
            setTimeout(() => {
                msgDiv.querySelectorAll('pre code').forEach((block) => {
                    processCodeBlock(block);
                    hljs.highlightElement(block);
                });
                scrollToBottom(); // Let the scroll handler decide if we should scroll
            }, 50);

            return msgDiv;
        }

        // Textarea Auto-Grow
        messageInput.addEventListener('input', function() {
            const minHeight = 45;
            this.style.height = `${minHeight}px`;
            const scrollHeight = this.scrollHeight;
            this.style.height = `${Math.max(minHeight, Math.min(scrollHeight, 150))}px`;
        });

        // Enter Key Handler
        messageInput.addEventListener('keydown', (event) => {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (event.key === 'Enter') {
                if (isMobile) {
                    // On mobile: Shift+Enter sends, Enter creates new line
                    if (event.shiftKey) {
                        event.preventDefault();
                        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
                    }
                } else {
                    if (!event.shiftKey) {
                        event.preventDefault();
                        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
                    }
                }
            }
        });
        
        window.addEventListener('beforeunload', async () => {
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            await fetch('/save_session', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken  // Add CSRF token to headers
                },
                body: JSON.stringify({ session_id: getCookie('session_id') })
            });
        });

        window.addEventListener('beforeunload', async () => {
            const input = document.getElementById('messageInput');
            if (input.value.trim() !== '') {
                await saveSession();
            }
        });

        let chatHistory = [];
        const isLoggedIn = document.getElementById('isLoggedIn').value === 'true';

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const lazyLoadObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    lazyLoadObserver.unobserve(img);
                }
            });
        });

        document.querySelectorAll('.lazy-load').forEach(img => {
            lazyLoadObserver.observe(img);
        });

        // Form Handler
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;

            // Validation checks
            if (!formData.get('message')?.trim() && !imageInput.files[0]) {
                alert('Please enter a message or attach an image');
                return;
            }
            
            // Clear image preview and adjust textarea height
            document.getElementById('imagePreview').innerHTML = '';

            // Disable input during processing
            messageInput.disabled = true;
            document.getElementById('loading').style.display = 'block';

            try {

                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }

                // Clear input and add messages
                const userContent = formData.get('message')?.trim() || '';
                const sessionId = formData.get('session_id');

                // Create user message
                const userMessageDiv = appendMessage([{ type: 'text', content: userContent }], 'user');

                // Handle image if present
                if (imageInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'chat-image';
                        let messageContent = userMessageDiv.querySelector('.message-content');
                        if (!messageContent) {
                            messageContent = document.createElement('div');
                            messageContent.className = 'message-content';
                            userMessageDiv.appendChild(messageContent);
                        }
                        messageContent.prepend(img);
                    };
                    reader.readAsDataURL(imageInput.files[0]);
                    imageInput.value = '';
                    messageInput.value = '';
                } else {
                    messageInput.value = '';
                }

                let modelMessage = null;
                let fullResponse = '';

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let done = false;
                let receivedError = false;

                while (!done) {
                    const { value, done: streamDone } = await reader.read();
                    done = streamDone;

                    if (value) {
                        const chunk = decoder.decode(value);
                        const lines = chunk.trim().split("\n");

                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                try {
                                    const jsonStr = line.replace("data: ", "").trim();
                                    const data = JSON.parse(jsonStr);

                                    if (data.chunk) {
                                        if (!modelMessage) {
                                            modelMessage = appendMessage([], 'model');
                                            document.getElementById('loading').style.display = 'none';
                                            messageInput.style.height = '45px';
                                        }
                                        
                                        const cleanedChunk = data.chunk.replace(/\n+$/, '');
                                        fullResponse += cleanedChunk;
                                        
                                        const contentDiv = modelMessage.querySelector('.message-content');
                                        contentDiv.innerHTML = marked.parse(fullResponse);
                                        
                                        setTimeout(() => {
                                            hljs.highlightAll();
                                            // Process code blocks after each chunk
                                            contentDiv.querySelectorAll('pre code').forEach((block) => {
                                                // Check if elements already exist
                                                if (!block.parentNode.querySelector('.language-label')) {
                                                    const language = block.className.split('-')[1] || 'code';
                                                    const label = document.createElement('div');
                                                    label.className = 'language-label';
                                                    label.textContent = language;
                                                    block.parentNode.insertBefore(label, block);
                                                }
                                                if (!block.parentNode.querySelector('.copy-button')) {
                                                    const button = document.createElement('button');
                                                    button.className = 'copy-button';
                                                    button.innerHTML = `
                                                        <svg viewBox="0 0 24 24">
                                                            <path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                                                        </svg>
                                                    `;
                                                    button.onclick = () => {
                                                        navigator.clipboard.writeText(block.innerText);
                                                        button.innerHTML = `
                                                            <svg viewBox="0 0 24 24">
                                                                <path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/>
                                                            </svg>
                                                        `;
                                                        button.classList.add('success');
                                                        setTimeout(() => {
                                                            button.innerHTML = `
                                                                <svg viewBox="0 0 24 24">
                                                                    <path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                                                                </svg>
                                                            `;
                                                            button.classList.remove('success');
                                                        }, 2000);
                                                    };
                                                    block.parentNode.appendChild(button);
                                                }
                                            });
                                            scrollToBottom();
                                        }, 50);
                                    }

                                    if (data.error) {
                                        receivedError = true;
                                        throw new Error(data.error);
                                    }
                                    if (!receivedError) {
                                        updateSessionList();
                                        scrollToBottom();
                                    }

                                } catch (err) {
                                    console.error("JSON Parse Error:", err, "Chunk:", line);
                                    appendMessage([{ type: 'text', content: `Error: ${err.message}` }], 'error');
                                }
                            }
                        }
                    }
                }

                updateSessionList();
                document.getElementById('chatType').value = "{{ config.name }}";

            } catch (err) {
                console.error('Stream error:', err);
                appendMessage([{ type: 'text', content: `Error: ${err.message}` }], 'error');
            } finally {
                messageInput.disabled = false;
                imageInput.value = '';
                if (!isMobile) {
                    messageInput.focus();
                }
                updateSessionList();
                document.getElementById('loading').style.display = 'none';
                
                // Use the existing session_id instead of undefined newSessionId
                const sessionId = formData.get('session_id');
                document.cookie = `session_id=${sessionId}; path=/; samesite=strict`;
            }
        });

        setTimeout(() => {
            if (modelMessage) {
                const contentDiv = modelMessage.querySelector('.message-content');
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    if (!block.parentNode.querySelector('.language-label')) {
                        const classNames = block.className.split(' ');
                        let language = 'code';
                        // Check for classes starting with 'language-'
                        for (const className of classNames) {
                            if (className.startsWith('language-')) {
                                language = className.replace('language-', '');
                                break;
                            }
                        }
                        // If not found, use the first non-hljs class
                        if (language === 'code') {
                            for (const className of classNames) {
                                if (className !== 'hljs' && className !== '') {
                                    language = className;
                                    break;
                                }
                            }
                        }
                        const label = document.createElement('div');
                        label.className = 'language-label';
                        label.textContent = language;
                        block.parentNode.insertBefore(label, block);
                    }
                    if (!block.parentNode.querySelector('.copy-button')) {
                        const button = document.createElement('button');
                        button.className = 'copy-button';
                        button.innerHTML = `
                            <svg viewBox="0 0 24 24">
                                <path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                            </svg>
                        `;
                        button.onclick = () => {
                            navigator.clipboard.writeText(block.innerText);
                            button.innerHTML = `
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/>
                                </svg>
                            `;
                            button.classList.add('success');
                            setTimeout(() => {
                                button.innerHTML = `
                                    <svg viewBox="0 0 24 24">
                                        <path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                                    </svg>
                                `;
                                button.classList.remove('success');
                            }, 2000);
                        };
                        block.parentNode.appendChild(button);
                    }
                });
                hljs.highlightAll();
            }
        }, 50);

        async function updateSessionList() {
            const chatType = document.getElementById('chatType').value;
            const sessionList = document.querySelector('.session-list');
            
            if (!sessionList) return; // Exit if no session list element

            try {
                const response = await fetch(`/api/sessions/${chatType}?nocache=${Date.now()}`);
                const sessions = await response.json();
                
                // Only update if we have sessions
                if (sessions.length > 0) {
                    sessionList.innerHTML = sessions.map(session => `
                        <li class="session-item">
                            <a href="/chat/session/${session.session_id}">
                                <span class="chat-type">${session.title}</span>
                            </a>
                        </li>
                    `).join('');
                }
            } catch (err) {
                console.error('Error updating sessions:', err);
            }
        }

        function scrollToBottom() {
            if (!userInterruptedScroll) {
                const chatBox = document.querySelector('.chat-box');
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        document.querySelector('.chat-box').addEventListener('scroll', () => {
            const chatBox = document.querySelector('.chat-box');
            const threshold = 100; // Pixels from bottom considered "near bottom"
            const scrollPosition = chatBox.scrollTop + chatBox.clientHeight;
            const isNearBottom = (chatBox.scrollHeight - scrollPosition) < threshold;

            // Immediately update interruption state when user scrolls
            userInterruptedScroll = !isNearBottom;

            // Clear any existing timeout
            if (scrollTimeout) clearTimeout(scrollTimeout);

            // If user scrolls back to bottom, re-enable auto-scroll after a brief pause
            if (isNearBottom) {
                scrollTimeout = setTimeout(() => {
                    userInterruptedScroll = false;
                }, 1000); // 1 second delay before re-enabling auto-scroll
            }
        });

        async function restartChat() {
            const messages = document.querySelectorAll('.message');
            const userMessages = document.querySelectorAll('.user-msg');
            if (userMessages.length === 0) {
                alert('Please start a conversation before creating a new chat.');
                return;
            }

            const isLoggedIn = document.getElementById('isLoggedIn').value === 'true';
            const chatType = document.getElementById('chatType').value;
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;

            try {
                if (isLoggedIn) {
                    const response = await fetch(`/new_chat/${chatType}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        window.location.href = `/chat/session/${data.new_session_id}?nocache=${Date.now()}`;
                    }
                } else {
                    window.location.href = `/chat/${chatType}?nocache=${Date.now()}`;
                }
            } catch (err) {
                console.error('Error restarting chat:', err);
            }
        }

        // Sidebar Toggle Functions
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
            document.body.classList.toggle('sidebar-open');
            document.querySelectorAll('.menu-options').forEach(menu => {
                menu.classList.remove('active');
            });
        }

        window.addEventListener('resize', () => {
            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('collapsed');
                document.body.classList.remove('sidebar-open');
            }
            document.querySelectorAll('.menu-options').forEach(menu => {
                menu.style.left = '';
                menu.style.right = '';
                menu.style.marginLeft = '';
                menu.style.marginRight = '';
            });
        });

        // Session Management Functions
        function confirmDelete(sessionId) {
            currentSessionToDelete = sessionId;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        async function deleteChatSession(sessionId) {
            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const response = await fetch(`/delete_chat/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (response.ok) {
                    const sessionItem = document.querySelector(`.session-item[data-session-id="${sessionId}"]`);
                    if (sessionItem) sessionItem.remove();
                    
                    const currentSessionId = getCookie('session_id');
                    if (sessionId === currentSessionId) {
                        window.location.href = '/';
                    }
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        function startRenaming(sessionId, currentTitle) {
            const sessionItem = document.querySelector(`.session-item[data-session-id="${sessionId}"]`);
            const titleElement = sessionItem.querySelector('.chat-type');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'rename-input';
            
            titleElement.replaceWith(input);
            input.focus();
            
            input.addEventListener('blur', () => finishRenaming(sessionId, input));
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') finishRenaming(sessionId, input);
            });
        }

        async function finishRenaming(sessionId, input) {
            const newTitle = input.value.trim();
            if (!newTitle) return;

            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const response = await fetch(`/rename_chat/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ new_title: newTitle })
                });

                if (response.ok) {
                    const titleElement = document.createElement('span');
                    titleElement.className = 'chat-type';
                    titleElement.textContent = newTitle;
                    input.replaceWith(titleElement);
                }
            } catch (error) {
                console.error('Rename error:', error);
            }
        }

        // Code Block Processing
        function processAllCodeBlocks() {
            document.querySelectorAll('pre code').forEach(block => {
                processCodeBlock(block);
            });
        }

        function processCodeBlock(block) {
            // Remove any existing language labels or copy buttons
            block.parentNode.querySelectorAll('.language-label, .copy-button').forEach(el => el.remove());

            // Define tokens to ignore when extracting language
            const unwanted = new Set(['hljs', 'language']);
            let language = 'text';

            // Extract language from 'language-xxx' class
            const match = block.className.match(/language-(\w+)/);
            if (match) {
                language = match[1];
            } else {
                // Fallback: filter classes and use the first remaining
                const classes = block.className.split(/\s+/).filter(c => !unwanted.has(c.toLowerCase()));
                if (classes.length > 0) language = classes[0];
            }

            // Create and insert the language label
            const label = document.createElement('div');
            label.className = 'language-label';
            label.textContent = language;
            block.parentNode.insertBefore(label, block);

            // Create and add the copy button (existing code)
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                </svg>
            `;
            button.onclick = () => {
                navigator.clipboard.writeText(block.innerText);
                button.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/>
                    </svg>
                `;
                button.classList.add('success');
                setTimeout(() => {
                    button.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                        </svg>
                    `;
                    button.classList.remove('success');
                }, 2000);
            };
            block.parentNode.appendChild(button);

        }


        // Mobile Handling
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            document.querySelector('.sidebar').classList.add('collapsed');
            document.body.classList.add('mobile');
        }

        let touchStartX = 0;
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            const deltaX = touchEndX - touchStartX;
            const sidebar = document.querySelector('.sidebar');

            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0 && touchStartX < 50) {
                    sidebar.classList.remove('collapsed');
                } else if (deltaX < 0 && !sidebar.classList.contains('collapsed')) {
                    sidebar.classList.add('collapsed');
                }
            }
        });

        // Initial Setup
        window.addEventListener('DOMContentLoaded', () => {
            if (!isMobile) document.getElementById('messageInput').focus();
            processAllCodeBlocks();
            scrollToBottom();

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-menu')) {
                    document.querySelectorAll('.menu-options.active').forEach(menu => {
                        menu.classList.remove('active');
                        menu.closest('.session-item').classList.remove('menu-active');
                    });
                }
            });

            const observer = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.classList?.contains('message')) {
                            node.querySelectorAll('pre code').forEach(block => {
                                processCodeBlock(block);
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.querySelector('.chat-box'), {
                childList: true,
                subtree: true
            });
        });

        // Robust Fetch Helper
        async function robustFetch(url, options, retries = 3, delay = 2000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    throw new Error(`HTTP ${response.status}`);
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        function toggleMenu(button) {
            const menu = button.closest('.chat-menu').querySelector('.menu-options');
            const sessionItem = button.closest('.session-item');
            const wasActive = menu.classList.contains('active');

            // Close all menus first
            document.querySelectorAll('.menu-options.active').forEach(otherMenu => {
                otherMenu.classList.remove('active');
                otherMenu.closest('.session-item').classList.remove('menu-active');
            });

            // Toggle current menu
            if (!wasActive) {
                menu.classList.add('active');
                sessionItem.classList.add('menu-active');
            }

            // Position adjustment for mobile
            if (window.innerWidth <= 768) {
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = 'auto';
                    menu.style.right = '100%';
                    menu.style.marginLeft = '0';
                    menu.style.marginRight = '8px';
                }
            }
        }
        function handleDeleteConfirmation(confirm) {
            const modal = document.getElementById('deleteModal');
            if (confirm && currentSessionToDelete) {
                deleteChatSession(currentSessionToDelete);
            }
            modal.style.display = 'none';
            currentSessionToDelete = null;
        }
        let currentSessionToDelete = null;

        function updateFileInput() {
            document.getElementById('imageInput').value = '';
        }

        function handleImageUpload(e) {
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview';
                    
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'preview-image';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-image-button';
                    removeBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="20" height="20">
                            <g data-name="23-Remove">
                                <path d="M23.29 7.29 16 14.59l-7.29-7.3-1.42 1.42 7.3 7.29-7.3 7.29 1.42 1.42 7.29-7.3 7.29 7.3 1.42-1.42-7.3-7.29 7.3-7.29-1.42-1.42z"/>
                            </g>
                        </svg>
                    `;
                    removeBtn.onclick = function() {
                        previewDiv.remove();
                        updateFileInput();
                    };
                    
                    previewDiv.appendChild(removeBtn);
                    previewDiv.appendChild(img);
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('imageInput').addEventListener('change', handleImageUpload);
    </script>
</body>
{% endblock %}