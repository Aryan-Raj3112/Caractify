{% extends "layout.html" %}

{% block content %}
<body>
    <header class="header">
        <img src="{{ url_for('static', filename='gemini.webp') }}" alt="Logo">
        <h2>Orion</h2>
    </header>

    <div class="chat-box">
        {% if chat_history %}
            {% for message in chat_history %}
                <div class="message {{ message['role'] }}-msg">
                    {% if message['role'] == 'model' %}
                        {{ message['parts'] | markdown | safe }}
                    {% else %}
                        {{ message['parts'] | safe }}
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Loading Spinner -->
    <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="loading-spinner"></div>
    </div>

    <footer class="footer">
        <form action="/chat" method="POST" id="chatForm">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <textarea autocomplete="off" autofocus name="message" 
                      placeholder="Enter your message" required id="messageInput"></textarea>
        </form>
    </footer>
    <script>
        const messageInput = document.getElementById('messageInput');
        const chatForm = document.getElementById('chatForm');
        const loadingSpinner = document.getElementById('loading');

        // Auto-scroll to bottom
        function scrollToBottom() {
            const chatBox = document.querySelector('.chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Show spinner and scroll on submit
        chatForm.addEventListener('submit', () => {
            loadingSpinner.style.display = 'block';
            scrollToBottom();
        });

        // Initial scroll
        window.onload = scrollToBottom;

        // Textarea auto-resize
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const newHeight = Math.max(30, Math.min(this.scrollHeight, 160));
            this.style.height = newHeight + 'px';
        });
        
        // Enter key handling
        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                loadingSpinner.style.display = 'block';
                scrollToBottom();
                chatForm.submit();
                messageInput.value = '';
            }
        });
    </script>
</body>
{% endblock %}